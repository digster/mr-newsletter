# Work Summary - 2026-01-31

## Task: Fix Playwright VNC Browser Visibility

### Problem
The Playwright VNC container showed a desktop in VNC but no browser window. The `playwright run-server` command hardcodes `headless: true` internally with no CLI override.

### Solution
Replaced `npx playwright run-server` with a custom Node.js script that uses `chromium.launchServer()` API with `headless: false`.

### Files Created
1. **`~/lab/tools/browser-container/playwright-server.js`** - Custom Node.js script that:
   - Uses `chromium.launchServer()` with `headless: false`
   - Listens on `0.0.0.0:3000` for WebSocket connections
   - Includes graceful shutdown handling

2. **`~/lab/tools/browser-container/package.json`** - Dependencies for the custom script:
   - `playwright: 1.58.0` (matching the base image version)

### Files Modified
1. **`~/lab/tools/browser-container/Dockerfile`**:
   - Added `/app` directory creation
   - Added `package.json` copy and `npm install`
   - Added `playwright-server.js` copy

2. **`~/lab/tools/browser-container/supervisord.conf`**:
   - Replaced direct Chromium launch with `node /app/playwright-server.js`
   - Updated logging paths

3. **`~/lab/mr-newsletter/.mcp.json`**:
   - Changed `playwright-vnc` config from `--cdp-endpoint` to `--ws-endpoint`
   - Port remains `ws://localhost:3001` (host mapping of container port 3000)

### Key Insights
- The Microsoft Playwright Docker image has browsers pre-installed but NOT the npm package
- `chromium.launchServer()` creates a WebSocket server (proper for Playwright MCP)
- `--cdp-endpoint` expects raw Chrome DevTools Protocol, `--ws-endpoint` expects Playwright WebSocket
- Container port 3000 maps to host port 3001 (per docker-compose.yml)

### Verification
- VNC viewer accessible at: `http://localhost:7901/vnc.html?autoconnect=1&resize=scale&password=secret`
- Playwright MCP successfully navigated to google.com
- Browser window visible in VNC (headed mode working)
- Screenshot captured confirming functionality

### Note
DNS resolution for `example.com` returns localhost inside the container (OrbStack quirk), but other domains like `google.com` resolve correctly.

---

## Task: Configure E2E Tests for VNC Browser Container

### Problem
E2E tests were running with local Playwright browser instead of the VNC container at `ws://localhost:3001`.

### Solution
Updated test configuration to connect to the remote Playwright server in the VNC container.

### Files Modified

1. **`tests/e2e/conftest.py`** - Complete rewrite for VNC support:
   - Added `get_vnc_ws_endpoint()` to fetch dynamic WebSocket endpoint from `/json`
   - Custom `browser` fixture using `playwright.connect(ws_endpoint)`
   - Uses `host.docker.internal` so Docker container can reach host app
   - Environment variable `USE_VNC_BROWSER` (default: true) to toggle modes

2. **`tests/e2e/page_objects/base_page.py`**:
   - Changed from hardcoded `127.0.0.1` to dynamic host resolution
   - Respects `USE_VNC_BROWSER` and `APP_HOST` environment variables

3. **`pyproject.toml`**:
   - Upgraded `playwright>=1.57.0` to `playwright>=1.58.0`
   - Version must match VNC container's Playwright server

### Test Results
- **42 passed, 5 failed** (same as local browser)
- 5 failures are expected: URL assertion tests that fail due to auth redirect to `/login`

### Key Insights
- `host.docker.internal` allows Docker containers to access host machine services
- Playwright client/server versions MUST match exactly (428 error if mismatch)
- pytest-playwright fixtures needed to be completely overridden for remote browser
- WebSocket endpoint is dynamic: fetched via HTTP GET `/json`

### Commands
```bash
# Run with VNC browser (default)
uv run pytest tests/e2e/ -v --no-cov

# Run with local browser
USE_VNC_BROWSER=false uv run pytest tests/e2e/ -v --no-cov

# Watch tests via VNC
open http://localhost:7901  # Web VNC viewer
```
